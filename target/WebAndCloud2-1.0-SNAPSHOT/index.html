<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TinyLDF</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>


<!-- <script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>


<script src="https://accounts.google.com/gsi/client" async defer></script>

<script src="https://unpkg.com/mithril/mithril.js"></script>

</head>
<body>

<script>	

var LDFView = {
  subject: '',
  predicate: '',
  object: '',

  view: function() {
    return m('div', [
      m('div', { style: 'font-size:19px; font-weight:bold;margin-bottom:12px; color:#333333;' }, "Query TinyLDF by triple pattern"),
      m('div', { style: 'margin-bottom: 10px; margin-left:27px;' }, [
        m('label', { style: 'display: inline-block; width: 80px; font-weight: bold;' }, "subject:"),
        m("input[type=text]", {
          value: LDFView.subject,
          oninput: function(e) { LDFView.subject = e.target.value; },
          style: 'width: 70%; border: none; border-bottom: 1px solid #ccc; outline: none; color: #be1622;'
        })
      ]),
      m('div', { style: 'margin-bottom: 10px; margin-left:27px;' }, [
        m('label', { style: 'display: inline-block; width: 80px; font-weight: bold;' }, "predicate:"),
        m("input[type=text]", {
          value: LDFView.predicate,
          oninput: function(e) { LDFView.predicate = e.target.value; },
          style: 'width: 70%; border: none; border-bottom: 1px solid #ccc; outline: none; color: #be1622;'
        })
      ]),
      m('div', { style: 'margin-bottom: 10px; margin-left:27px;' }, [
        m('label', { style: 'display: inline-block; width: 80px; font-weight: bold;' }, "object:"),
        m("input[type=text]", {
          value: LDFView.object,
          oninput: function(e) { LDFView.object = e.target.value; },
          style: 'width: 70%; border: none; border-bottom: 1px solid #ccc; outline: none; color: #be1622;'
        })
      ]),
     
      m('button', {
        class: 'custom-button',
        style: {
          border: '1px solid #898989',
          backgroundColor: '#f6f6f6',
          padding: '4px 8px',
          cursor: 'pointer',
          borderRadius: '3px',
          marginRight: '10px'
        },
        onclick: function(e) {
          Triplet.search(LDFView.subject, LDFView.predicate, LDFView.object);
        }
      }, m('span', {
        style: {
          color: '#be1622',
          fontWeight: 'bold',
          fontSize: '15px'
        }
      }, "Find matching triples")),

      m('button', {
        class: 'custom-button',
        style: {
          border: '1px solid #898989',
          backgroundColor: '#f6f6f6',
          padding: '4px 8px',
          cursor: 'pointer',
          borderRadius: '3px',
          display: Login.name === '' ? 'none' : 'inline-block'
        },
        disabled: Login.name === '',
        onclick: function(e) {
          Triplet.save(LDFView.subject, LDFView.predicate, LDFView.object);
          LDFView.subject = '';
          LDFView.predicate = '';
          LDFView.object = '';
          m.redraw();
        }
      }, m('span', {
        style: {
          color: '#be1622',
          fontWeight: 'bold',
          fontSize: '15px'
        }
      }, "Add triples")),
    ]);
  }
};

var Triplet = {
	    list: [],
      noResultMessage : null,
	    loadList: function() {
	        return m.request({
	            method: "GET",
              url: "_ah/api/myApi/v1/showTriplets/"
	        })
	        .then(function(result) {
            Triplet.list = result.items
	        	console.log("got:",result.items)
	        	// m.redraw(true)
	        })
	    },
	    save: function(subject, predicate, object) {
	    	console.log("saving...",Triplet.current)
        if (!subject || !predicate || !object) {
          alert("Please fill in all fields (subject, predicate, object).");
          return;
        }

        return m.request({
            method: "GET",
            url: `_ah/api/myApi/v1/addTriplet/${subject}/${predicate}/${object}`+'?access_token=' + Login.token
        })
        .then(function(result) {
          console.log("got:",result)
          Triplet.loadList()
        })
        .catch(function(error) {
          console.error("Error saving triplet:", error);
          alert("Error saving triplet hhhh, please try again!");
        })
	    },

      search: function(subject, predicate, object) {
        console.log("searching...", Triplet.current);
        
        var queryParams = [];
        if (subject) queryParams.push(`subject=${encodeURIComponent(subject)}`);
        if (predicate) queryParams.push(`predicate=${encodeURIComponent(predicate)}`);
        if (object) queryParams.push(`object=${encodeURIComponent(object)}`);
        
        var queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
        
        return m.request({
            method: "GET",
            url: `_ah/api/myApi/v1/searchTriplet${queryString}`
        })
        .then(function(result) {
          console.log("got:", result);
          if (result.items && result.items.length > 0) {
            Triplet.list = result.items;
            Triplet.noResultMessage = null; 
          }
          else {
            Triplet.list = [];
            Triplet.noResultMessage = "TinyLDF contains no triples that match this pattern.";
          }
          if (Triplet.list.length !== 0){
            Triplet.noResultMessage = null;
          }
          m.redraw(true);
        })
        .catch(function(error) {
            console.error("Error searching triplet:", error);
            alert("Error searching for triplet XD, please try again!");
        });
      }
	}

  var TripleView = {
  oninit: Triplet.loadList,
  view: function() {
    return m('div', [
      m('div', { style: 'font-size:19px; font-weight:bold; color:#333333;' }, "Matches in TinyLDF for"),
      m('div', { style: 'font-size:16px; color:#898989;' }, "Showing triples 1 to 101 of ± 300,020 with 100 triples per page."),
      m('table', {class: 'table is-striped', style: "width:100%; text-align: center;"}, [
        m('thead', 
          m('tr', [
            m('th', {style: "width:33%; text-align: center;"}, "Subject"),
            m('th', {style: "width:33%; text-align: center;"}, "Predicate"),
            m('th', {style: "width:33%; text-align: center;"}, "Object"),
          ])
        ),
        m('tbody', 
          Triplet.list.map(function(item) {
            return m("tr", [
              m('td', {style: "text-align: center; padding:0;"}, m('label', item.properties.subject)),
              m('td', {style: "text-align: center; padding:0;"}, m('label', item.properties.predicate)),
              m('td', {style: "text-align: center; padding:0;"}, m('label', item.properties.object)),
            ])
          })
        ),
      ]),
      m('div', { style: 'margin-top: 10px; color: #BEBEBE;' }, Triplet.noResultMessage)
    ])
  }
}

var Login = {
  name:"",
  email:"",
  ID:"",
  url:"",
  token:"",
  loggedIn:false,
  handleCredential: function(response) {
    console.log("callback called:"+response.credential)
    // decodeJwtResponse() is a custom function defined by you
    // to decode the credential response.
    const responsePayload = jwt_decode(response.credential);
   
    console.log("ID: " + responsePayload.sub);
    console.log('Full Name: ' + responsePayload.name);
    console.log('Given Name: ' + responsePayload.given_name);
    console.log('Family Name: ' + responsePayload.family_name);
    console.log("Image URL: " + responsePayload.picture);
    console.log("Email: " + responsePayload.email);

    Login.name= responsePayload.name
    Login.email= responsePayload.email
    Login.ID= response.credential
    Login.url= responsePayload.picture 
	  Login.token= response.credential
    Login.loggedIn= true
    m.redraw()
  }
}

var LoginView2 = {
    view: function() {
 	    return m('div', {class:'container'}, [
      m("h1", {style: 'font-size:19px; font-weight:bold;margin-bottom:10px; color:#333333;'}, 'Login'),
      m("div", {
      	   "id":"g_id_onload",
      	   "data-client_id":"418717520776-vd1hi1ukmn4494md8h75odm29dn05n8i.apps.googleusercontent.com",
           "data-callback": "handleCredentialResponse"}),
      m("div", {
      	   "class":"g_id_signin",
      	   "data-type":"standard"}),
      m("li", {style: 'margin-left:27px; font-weight:bold; margin-bottom:12px;'}, "name: "+Login.name),
      m("li", {style: 'margin-left:27px; font-weight:bold; margin-bottom:12px;'}, "email: "+Login.email),
      //m("img",{"src":Login.url}),
      ])
    }
}

var LoginView = {
  view: function () {
    return m("div", { 
      class: "header", 
      style: "display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ccc; padding-top:0;" 
    }, [
      Login.loggedIn
        ? m("div", { style: "display: flex; align-items: center;" }, [
            m("img", {
              src: Login.url,
              alt: "Profile Picture",
              style: "width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;",
            }),
            m("span", { style: "font-size: 16px; font-weight: bold; color: #333;" }, Login.name),
          ])
        : m("div", { style: "display: flex; align-items: center;" }, [
            m("img", {
              src: "guest.jpg",
              alt: "Guest",
              style: "width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;",
            }),
            m("span", { style: "font-size: 16px; font-weight: bold; color: #333;" }, "Guest"),
          ]),
      m("div", [
        m("div", {
          id: "g_id_onload",
          "data-client_id": "418717520776-vd1hi1ukmn4494md8h75odm29dn05n8i.apps.googleusercontent.com",
          "data-callback": "handleCredentialResponse",
        }),
        m("div", {
          class: "g_id_signin",
          "data-type": "standard",
          style: !Login.loggedIn ? "" : "display: none;", // Hide button when logged in
        }),
      ]),
    ]);
  },
};

function handleCredentialResponse(response) {
    console.log("callback called:"+response.credential)
    Login.handleCredential(response)
}

document.body.style.backgroundColor = "#f6f6f6";

var Hello = {
    view: function() {
        return m('div', {
            class: 'container box',
            style: "width: 70%; min-width:560px; margin: 0 auto; padding: 14px 4% 1%; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.8); position: relative;"
        }, [
            m("div", {style: "margin-bottom: 20px;"}, m(LoginView)),
            m("img", {
                src: "TLDLogo.png",
                alt: "TLD Logo",
                style: "position: absolute; top: 80px; right: 50px; width: 145px; height: auto;"
            }),
            m("h1", {style: 'font-size:30px; font-weight:bolder; color:black; margin-bottom:10px;'}, 'TinyLDF'),
            m("h1", {
              style: `
                font-size: 23px; 
                font-weight: bold; 
                color: #be1622; 
                margin-bottom: 5px; 
                text-decoration: none; 
                cursor: pointer;
                display: inline; 
                position: relative;
              `,
              onmouseover: (e) => {
                e.target.style.textDecoration = 'underline';
              },
              onmouseout: (e) => {
                e.target.style.textDecoration = 'none';
              },
              onclick: () => {
                window.location.href = "https://tinyldf.ey.r.appspot.com/";
              }
            }, 'TinyLDF'),
            m("div", {style: "margin-bottom: 20px;"}, m(LDFView)),
            m("div", {style: "margin-bottom: 20px;"}, m(TripleView)),
            m("div", [
              m("span",{style: "color: #B2B2B2; font-size:14px;"}, "Powered by a Tiny Linked Data Fragments  ©2024–2025 Nantes University - Oustra"),
            ])
        ])
    }
}
m.mount(document.body, Hello)	


</script>
</body>
</html>
